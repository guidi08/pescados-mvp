<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Automation Monitor</title>
  <style>
    body { font-family: system-ui, -apple-system, sans-serif; margin: 20px; background:#0b0f14; color:#e6edf3; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 16px; }
    .card { background:#111827; border:1px solid #1f2937; border-radius:12px; padding:14px; }
    .card.ok { border-color:#14532d; box-shadow: inset 0 0 0 1px #166534; }
    .card.warn { border-color:#7f1d1d; box-shadow: inset 0 0 0 1px #991b1b; }
    .title { font-weight:600; font-size:16px; margin-bottom:6px; }
    .meta { font-size:12px; color:#9ca3af; margin-bottom:6px; }
    .row { display:flex; justify-content:space-between; gap:8px; }
    .label { color:#9ca3af; }
    .value { color:#e6edf3; font-weight:500; }
    .status { font-size:12px; padding:3px 8px; border-radius:999px; background:#052e16; color:#86efac; }
    .status.warn { background:#3f0a0a; color:#fca5a5; }
    .header { display:flex; align-items:center; justify-content:space-between; margin-bottom:16px; }
    .badge { font-size:12px; padding:4px 8px; border-radius:999px; background:#1f2937; color:#9ca3af; }
  </style>
</head>
<body>
  <div class="header">
    <h1>Automation Monitor</h1>
    <div class="badge" id="last-update">Carregando…</div>
  </div>

  <h2>Status</h2>
  <div class="grid" id="states"></div>

  <script>
    const fmtTime = (t) => new Date(t * 1000).toLocaleString();

    const friendlyNames = {
      'auto_collect_state.json': 'Coleta de anexos (Gmail → /anexos)',
      'auto_triage_state.json': 'Triagem de anexos (pedido/asana)',
      'auto_momo_report_state.json': 'Relatório Momo (WhatsApp)',
      'auto_rep_report_state.json': 'Relatório Rep (WhatsApp)',
      '.telegram_bridge_state.json': 'Bridge Telegram',
      'state.json': 'Estado geral da automação',
    };

    // friendlySummary removido (leitura fácil focada em status)

    function detectFailure(summary) {
      if (!summary || typeof summary !== 'object') return null;
      const keys = ['error', 'errors', 'last_error', 'failure', 'failed'];
      for (const k of keys) {
        if (summary[k]) return `${k}: ${summary[k]}`;
      }
      return null;
    }

    function renderStateCard(item) {
      const div = document.createElement('div');
      const info = item.info || {};
      const title = friendlyNames[item.name] || item.name;
      const failure = detectFailure(item.summary);
      const statusOk = info.exists && !failure;
      div.className = `card ${statusOk ? 'ok' : 'warn'}`;

      const s = item.summary || {};
      const lastRunRaw = s.last_run || s.lastRun || null;
      const lastAttemptRaw = s.last_attempt || s.lastAttempt || null;

      const lastRun = lastRunRaw ? new Date(lastRunRaw).toLocaleString() : (info.exists ? fmtTime(info.mtime) : '—');
      const lastAttempt = lastAttemptRaw ? new Date(lastAttemptRaw).toLocaleString() : (info.exists ? fmtTime(info.mtime) : '—');
      const failures = failure || (info.exists ? 'Nenhuma' : 'Arquivo não encontrado');

      div.innerHTML = `
        <div class="row">
          <div class="title">${title}</div>
          <div class="status ${statusOk ? '' : 'warn'}">${statusOk ? 'OK' : 'ALERTA'}</div>
        </div>
        <div class="row meta"><span class="label">Última execução</span><span class="value">${lastRun}</span></div>
        <div class="row meta"><span class="label">Última tentativa</span><span class="value">${lastAttempt}</span></div>
        <div class="row meta"><span class="label">Falhas</span><span class="value">${failures}</span></div>
      `;
      return div;
    }

    // logs removidos nesta versão simplificada

    async function load() {
      const res = await fetch('/status');
      const data = await res.json();
      document.getElementById('last-update').textContent = `Atualizado: ${fmtTime(data.now)}`;

      const states = document.getElementById('states');
      states.innerHTML = '';
      data.states.forEach(s => states.appendChild(renderStateCard(s)));

      // logs removidos na versão simplificada
    }

    load();
    setInterval(load, 5000);
  </script>
</body>
</html>
